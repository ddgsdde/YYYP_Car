# 智能车循迹系统 - Smart Car Line Follower System

## 📋 项目概述

这是一个**简化且稳定**的智能车循迹控制系统，基于ESP32-S3开发，专注于**高性能PID循迹控制**。

### 🎯 设计理念
- **专注核心功能**：纯循迹，无额外任务干扰
- **PID+权重算法**：精确控制，平滑跟线
- **实时可调参数**：Web界面动态调整，无需重新编译
- **增强稳定性**：完善的异常处理和状态机设计
- **调试友好**：三级调试系统（串口+OLED+Web）

## ✨ 核心功能

1. **权重+PID循迹** - 8通道加权位置计算 + PID差速控制
2. **按键启停控制** - 一键启动/停止，长按重置统计
3. **Web实时调试** - 参数在线调整、传感器监控、手动控制
4. **动态速度调整** - 根据偏差自动调整基础速度
5. **智能丢线处理** - 基于历史位置的搜索策略
6. **运行统计** - 循环频率、运行时间、里程记录

## 🔧 硬件配置

### 主控
- ESP32-S3-R8N16 (8MB PSRAM + 16MB Flash)

### 传感器
- 8通道循迹传感器模块 (UART通信，115200波特率)
- 0.96寸 OLED显示屏 (SSD1306)
- VL53L0X 激光测距模块
- 超声波测距模块 (3.3V)

### 执行器
- 2个AS4950驱动的减速电机 (减速比21.7)
- AB相编码器 (11PPR)
- 声光报警器
- 舵机 (可选)

### 车辆参数
- 车长: 15cm
- 车宽: 19.18cm  
- 轮胎直径: 67.6mm
- 轮胎宽度: 26.4mm

## 📦 物料清单 (BOM)

1. **PCB**: 查看嘉立创`EDA`工程的`BOM`表（注意：第一个板不用打，超尺寸了已弃用）。**PCB工程文件位于项目根目录的 `Files/` 文件夹中。**
2. **车架**: `3D`打印车底座。**3D打印模型文件位于项目根目录的 `Files/` 文件夹中。**
3. **动力系统**: 两个编码器电机 + 轮胎等
4. **测距模块**: `VL53L0X`激光测距模块
5. **避障模块**: 超声波模块（**必须使用3.3V供电**）
6. **辅助轮**: 一个小万向轮
7. **连接线**: 杜邦线等，按照自己需求购买线缆连接

## ⚠️ 组装注意事项

1. **焊接测试**: 焊接完毕后测试正常直接安装即可。
2. **MCU焊接**: 在焊接`mcu`模块时，如果使用锡膏要注意按键是否短路，短路会导致`esp32s3`无法正常启动。
3. **开发环境**: `Vscode`中必须安装`PlatformIO`拓展，编译后使用USB连接编译并烧录固件。
4. **烧录供电**: 烧录固件时主板必须处于通电状态。
5. **传感器安装**: 激光传感器建议用双面胶和胶带粘在侧方。

## 📌 引脚连接 (GPIO对应表)

| GPIO | 功能 | 说明 |
|------|------|------|
| IO8  | MS1    | 舵机PWM         |
| IO3  | ECHO   | 超声波           |
| IO18 | TX     | 循迹模块          |
| IO46 | O      | 声光报警高电平       |
| IO17 | RX     | 循迹模块          |
| IO9  | 1A     | 右电机编码器        |
| IO16 | SDA    | 外设 (VL53L0X)  |
| IO10 | 1B     | 右电机编码器        |
| IO15 | SCL    | 外设 (VL53L0X)  |
| IO11 | 2A     | 左电机编码器        |
| IO7  | 2I1    | 左电机           |
| IO12 | 2B     | 左电机编码器        |
| IO6  | 2I2    | 左电机           |
| IO13 | SCL2   | 屏幕            |
| IO5  | 1I1    | 右电机           |
| IO14 | SDA2   | 屏幕            |
| IO4  | 1I2    | 右电机           |
| IO1  | SW1    | 实体按键（按下接通GND） |
| IO2  | TOUCH2 | 触摸按键          |
| IO45 | EN3V3  | 3.3V外设供电使能    |
| IO39 | TRIG   | 超声波           |

## 🚀 快速开始与使用指南

### 1. 推荐流程
1. **硬件准备**: 定制PCB并完成焊接操作，测试`5v，3.3v`电压及电机驱动是否工作正常。
2. **固件烧录**: 安装`vscode`和`platfromio`插件，编译并烧录固件。
3. **整车组装**: 打印车模并安装，安装激光传感器等外设。
4. **参数调试**: 开始调参。

### 2. 编译上传

```bash
platformio run --target upload
```

### 3. 连接与调试

1. **WiFi连接**: 系统启动后会自动创建WiFi热点 `SmartCar_AP` (密码: `12345678`)。
2. **Web调试**: 连接WiFi后，浏览器访问 `http://192.168.4.1` 即可进行调试（上位机已内置）。
3. **操作控制**: 
   - **短按**物理按钮即可发车。
   - **再次短按**停止（注意：由于使用任务机制，在执行某些特定任务时可能无法立即停止）。

### 4. 检测传感器

页面会自动检测传感器状态，确保循迹传感器和编码器正常工作。

### 5. 调整参数

在Web界面中实时调整:
- **PID参数** (Kp=0.20, Ki=0.005, Kd=1.5 为推荐起始值)
- **速度参数** (慢速、正常、快速、转弯)
- **传感器权重** (默认 -1000 到 +1000 线性分布)

### 6. 开始循迹

1. 将小车放在黑线上
2. **短按**启动按键 → 开始循迹
3. **再次短按** → 停止循迹
4. **长按2秒** → 重置运行统计

## 📊 Web调试界面功能

### 实时状态监控
- **系统状态**: 运行/待机、运行时间
- **传感器数据**: 循迹位置 (-1000~+1000)、传感器状态 (0xFF)
- **PID调试**: P/I/D 三项实时数值
- **电机数据**: 左右轮速度 (mm/s)、里程 (mm)
- **性能指标**: 循环频率 (Hz)、丢线状态

### 参数实时调整
- **PID参数**: Kp (比例)、Ki (积分)、Kd (微分)
- **速度档位**: 慢速 (80)、正常 (150)、快速 (200)、转弯 (120)
- **传感器权重**: 8个传感器独立权重配置
- **保存功能**: Flash存储，断电不丢失

### 传感器检测
- **自动检测**: 页面加载自动检测所有传感器
- **实时刷新**: 500ms更新频率
- **状态指示**: ✅正常 / ❌异常 / ⏳检测中

### 手动控制
- **方向控制**: 前进、后退、左转、右转
- **特殊动作**: 180°原地转向
- **安全机制**: 暂停自动模式，松开停止

## 🎯 PID循迹算法详解

### 算法流程
```
1. 8通道传感器 → 加权位置计算 (-1000 ~ +1000)
2. 位置 → PID控制器 → 差速输出 (-255 ~ +255)
3. 基础速度 + 差速 → 左右轮速度
4. 动态调速：大偏差减速，小偏差加速
```

### 权重计算
```cpp
传感器: [0] [1] [2] [3] [4] [5] [6] [7]
权重:  -1000-750-500-250 250 500 750 1000
位置 = Σ(传感器i × 权重i) / Σ(传感器i × 1000)
```

### PID计算
```cpp
P项 = Kp × 位置误差       // 快速响应
I项 = Ki × Σ误差 × Δt     // 消除稳态误差
D项 = Kd × (误差变化率)   // 抑制振荡
输出 = P + I + D
```

### 动态速度策略
```cpp
if (|位置| > 700)  → 慢速 (80 PWM)
else if (|位置| > 400) → 中速 (115 PWM)
else → 正常速度 (150 PWM)
```

## ⚙️ PID调试技巧

### 推荐起始参数
```cpp
Kp = 0.20   // 比例：控制响应速度
Ki = 0.005  // 积分：消除稳态偏差
Kd = 1.5    // 微分：抑制振荡
```

### 调试步骤（Ziegler-Nichols方法改进版）

#### 第一步：调Kp
1. 设置 Ki=0, Kd=0
2. 从 Kp=0.1 开始逐渐增加
3. 观察：车子开始响应黑线
4. 继续增加直到出现**轻微振荡**
5. 记录此时的 Kp 值（称为 Ku）
6. 最终设置：**Kp = 0.6 × Ku**

#### 第二步：调Kd
1. 保持 Kp, Ki=0
2. 从 Kd=0.5 开始增加
3. 观察：振荡逐渐减小
4. 继续调整直到**平滑跟线，无振荡**
5. 推荐：**Kd = 1.5 ~ 3.0**

#### 第三步：调Ki（可选）
1. 保持 Kp 和 Kd
2. 从 Ki=0.001 开始增加
3. 观察：直线跑偏情况
4. 如果**无明显跑偏**，Ki保持很小或为0
5. 如果**持续偏向一侧**，增加 Ki
6. 注意：**Ki过大会导致超调**

### 常见问题及解决方案

| 现象 | 可能原因 | 解决方法 |
|------|---------|---------|
| 🐌 响应慢，转弯不及时 | Kp太小 | 增大Kp (步长0.05) |
| 🌊 左右摇摆严重 | Kp太大或Kd太小 | 减小Kp或增大Kd |
| ↗️ 直线持续偏向一侧 | Ki太小 | 增大Ki (步长0.002) |
| 🔄 过弯冲出赛道 | 速度太快 | 降低speedNormal |
| ⚡ 转弯时振荡 | Kd不足 | 增大Kd (步长0.5) |
| 💥 突然失控 | Ki太大导致积分饱和 | 减小Ki或重置系统 |

### 高级优化技巧

1. **权重调整**
   - 外侧传感器权重 ↑ → 转弯灵敏度 ↑
   - 内侧传感器权重 ↑ → 直线稳定性 ↑
   - 非线性权重：`[-1200, -800, -400, -150, 150, 400, 800, 1200]`

2. **动态速度**
   - 大偏差时自动减速（代码已实现）
   - 可根据赛道调整阈值 (700/400)

3. **丢线处理**
   - 系统已实现基于历史位置的智能搜索
   - 连续3次全白才判定丢线（避免误判）

4. **测试流程**
   ```
   低速测试 → 调PID → 中速测试 → 微调 → 高速测试 → 优化权重
   ```

## 🔍 调试模式

在`src/config.h`中可以开启不同的调试输出:

```cpp
#define DEBUG_SERIAL         true   // 串口调试
#define DEBUG_OLED           true   // OLED显示
#define DEBUG_LINE_SENSOR    false  // 循迹详细信息
#define DEBUG_ENCODER        false  // 编码器输出
#define DEBUG_PID            true   // PID三项数值
```

### 串口输出示例
```
Pos: -450 | P: -90.0 I:  -2.3 D: 120.5 | Out: 28.2 | L: 164 R: 136
Pos:  320 | P:  64.0 I:   1.8 D: -85.3 | Out:-19.5 | L: 130 R: 170
```

### OLED显示内容
```
RUN  T:45s          ← 状态和运行时间
S:0x18 P:0          ← 传感器状态和位置
P:0 I:0 D:0         ← PID三项
L:150 R:150         ← 左右轮速
─────────────────
Dist:12.5m          ← 累计里程
Freq:95Hz           ← 循环频率
```

## 📦 代码结构

```
src/
├── main.cpp              # 主程序和状态机
├── config.h              # 配置参数
├── LineSensor.h/cpp      # 循迹传感器
├── MotorControl.h/cpp    # 电机控制和编码器
├── PIDController.h/cpp   # PID控制器
├── Sensors.h/cpp         # 超声波和激光传感器
├── Display.h/cpp         # OLED显示
├── ParameterManager.h/cpp     # 参数管理和存储
└── WebServerManager.h/cpp     # Web服务器
```

## 🛠️ 依赖库

- ESP32Encoder - 编码器读取
- QuickPID - PID控制
- Adafruit_VL53L0X - 激光测距
- NewPing - 超声波测距
- Adafruit GFX & SSD1306 - OLED显示
- ESPAsyncWebServer - Web服务器
- ArduinoJson - JSON数据处理
- Preferences - 参数持久化存储

## 🎯 比赛任务清单

- [x] 循迹行驶
- [x] 物体长度测量
- [x] 障碍物避障 (偏出时间≤5秒)
- [x] 自动入库停车
- [x] 声光报警
- [x] 实时调试

## 📝 注意事项

1. **首次使用** - 先在测试环境调试PID参数
2. **光照影响** - 循迹传感器对光照敏感,建议现场校准
3. **电池电压** - 确保电池电量充足,电压不足会影响电机性能
4. **Web连接** - 比赛时可以连接Web界面实时监控
5. **参数备份** - 调好参数后记得保存,断电会丢失临时参数

## 🐛 故障排查

### 小车不走
- 检查电机连接
- 检查PWM输出
- 串口监视器查看日志

### 循迹不准
- 调整PID参数
- 检查传感器安装高度
- 查看Web界面传感器状态

### Web连接不上
- 确认WiFi已连接到SmartCar_AP
- 检查IP地址 (192.168.4.1)
- 查看串口输出的IP地址

### 避障失败
- 调整超声波阈值
- 增加避障距离参数
- 检查避障逻辑

## 📈 性能优化建议

1. **速度优化** - 直线段提高速度,弯道降低速度
2. **响应优化** - 根据场地调整PID参数
3. **避障优化** - 根据障碍物大小调整避障路径
4. **测量优化** - 激光传感器采样多次取平均

## 🏆 比赛策略

1. **稳定优先** - 初期以稳定完成为目标
2. **速度提升** - 稳定后逐步提高速度
3. **参数微调** - 根据现场情况微调参数
4. **多次测试** - 比赛前多次完整测试

## 🎬 比赛视频

> 由于 GitHub README 的安全限制，无法直接嵌入仓库内的视频文件进行内联播放。
> 请点击下方链接，跳转到 GitHub 播放器观看：

[**▶️ 点击观看比赛演示视频 (run.mp4)**](https://github.com/ScineceTechAILab/YYYP_Car/blob/master/run.mp4)

## 📞 技术支持

如有问题,请检查:
1. 串口监视器输出 (115200波特率)
2. Web界面实时状态
3. OLED显示屏信息

## 📄 版本信息

- Version: 1.0.0
- Date: 2025-01-13
- Platform: ESP32-S3
- Framework: Arduino

## 📜 开源协议

本项目采用 [GPL-3.0](LICENSE) 开源协议。
您可以自由地使用、修改和分发本项目代码，但必须保留原作者版权声明，且分发的衍生作品也必须采用相同的 GPL-3.0 协议开源。

---

**祝比赛顺利! 🏁**

POWERED BY DDG
